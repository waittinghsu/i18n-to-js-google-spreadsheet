#!/usr/bin/env node
const path = require('path');
const ConfigManager = require('../src/lib/configManager');
const { coreForGoogle, coreForLocal } = require('../src/lib/index');

async function main() {
  try {
    // 1. 解析命令行參數
    const configPath = process.argv[2];
    const loadPath = configPath?.includes('=') ? configPath.split('=')[1] : process.cwd();

    // 2. 初始化配置管理器並載入配置
    const configManager = new ConfigManager(loadPath);
    const option = configManager.getConfig();

    // 3. 執行核心邏輯
    console.log('🐢 🐢 google excel 擷取中 🐢🐢🐢 🧗...');
    const { mode = 'LOCAL' } = option;

    switch (mode) {
      case 'LOCAL':
        console.log('🦀 LOCAL 🦀');
        await coreForLocal(option);
        break;

      case 'GOOGLE_SHEET':
        console.log('🦀 GOOGLE_SHEET 🦀');
        await coreForGoogle(option)
          .then(() => {
            console.log('🎉 生成完成 🎉');
          });
        break;

      default:
        console.error(`⚠️ 不支援的模式：${mode}，預設使用 LOCAL 模式`);
        await coreForLocal(option);
        break;
    }

  } catch (error) {
    console.error(`👹 執行失敗：${error.message}`);
    if (error.missingFields) {
      console.error('缺失欄位:', error.missingFields);
    }
    process.exit(1);
  }
}

// 執行主程式
main().catch(err => {
  console.error(`👹 媽逼炸了‍${err}`);
  process.exit(1);
});
