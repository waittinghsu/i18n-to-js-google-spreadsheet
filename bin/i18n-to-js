#!/usr/bin/env node
const path = require('path');
const ConfigManager = require('../src/lib/configManager');
const { coreForGoogle, coreForLocal } = require('../src/lib/index');

async function main() {
  try {
    // 1. è§£æå‘½ä»¤è¡Œåƒæ•¸
    const configPath = process.argv[2];
    const loadPath = configPath?.includes('=') ? configPath.split('=')[1] : process.cwd();

    // 2. åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨ä¸¦è¼‰å…¥é…ç½®
    const configManager = new ConfigManager(loadPath);
    const option = configManager.getConfig();

    // 3. åŸ·è¡Œæ ¸å¿ƒé‚è¼¯
    console.log('ğŸ¢ ğŸ¢ google excel æ“·å–ä¸­ ğŸ¢ğŸ¢ğŸ¢ ğŸ§—...');
    const { mode = 'LOCAL' } = option;

    switch (mode) {
      case 'LOCAL':
        console.log('ğŸ¦€ LOCAL ğŸ¦€');
        await coreForLocal(option);
        break;

      case 'GOOGLE_SHEET':
        console.log('ğŸ¦€ GOOGLE_SHEET ğŸ¦€');
        await coreForGoogle(option)
          .then(() => {
            console.log('ğŸ‰ ç”Ÿæˆå®Œæˆ ğŸ‰');
          });
        break;

      default:
        console.error(`âš ï¸ ä¸æ”¯æ´çš„æ¨¡å¼ï¼š${mode}ï¼Œé è¨­ä½¿ç”¨ LOCAL æ¨¡å¼`);
        await coreForLocal(option);
        break;
    }

  } catch (error) {
    console.error(`ğŸ‘¹ åŸ·è¡Œå¤±æ•—ï¼š${error.message}`);
    if (error.missingFields) {
      console.error('ç¼ºå¤±æ¬„ä½:', error.missingFields);
    }
    process.exit(1);
  }
}

// åŸ·è¡Œä¸»ç¨‹å¼
main().catch(err => {
  console.error(`ğŸ‘¹ åª½é€¼ç‚¸äº†â€${err}`);
  process.exit(1);
});
